<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>钧鸢的阿拉伯语记忆</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
        }
        #start-screen h1 {
            color: #004d40;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin: 0.5rem;
        }
        /* Style for deck selection buttons */
        #deck-selection-container .deck-btn {
            background-color: #00695c;
            width: 80%;
            margin: 0.6rem auto;
        }
        #deck-selection-container .deck-btn:hover {
            background-color: #004d40;
        }
        #card-container {
            display: none;
        }
        #word-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #004d40;
            margin-bottom: 1rem;
            min-height: 80px; /* Ensure consistent height */
        }
        #answer-display {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
            min-height: 60px; /* Ensure consistent height */
        }
              #explanation-display {
            font-size: 1.1rem;
            color: #616161;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
            text-align: left;
            min-height: 40px;
        }
        .spoiler {
            background-color: #212121;
            color: #212121;
            cursor: pointer;
            user-select: none;
        }
        .spoiler.revealed {
            background-color: #f5f5f5;
            color: #c62828;
            cursor: default;
        }
/* 强制 .spoiler 规则覆盖 #explanation-display 的 ID 规则 */
#explanation-display.spoiler {
    color: #212121;/* 匹配背景色以隐藏[span_0](end_span) */
    background-color: #212121;/* 匹配背景色以隐藏[span_1](end_span) */
    border-top: none; /* 隐藏状态下不显示分隔线 */
}

/* 强制 .revealed 规则使用解释本来的颜色（灰色），而不是答案的红色 */
#explanation-display.spoiler.revealed {
    color: #616161; /* 恢复为解释的原始颜色[span_2](end_span) */
    background-color: #fff; /* 恢复为容器背景色[span_3](end_span) */
    border-top: 1px solid #e0e0e0; /* 恢复分隔线[span_4](end_span) */
}
        #controls {
             margin-top: 1.5rem;
        }
        #controls .btn {
            width: 120px;
        }
        #remembered-btn { background-color: #43a047; }
        #remembered-btn:hover { background-color: #388e3c; transform: translateY(-2px); }
        #forgot-btn { background-color: #e53935; }
        #forgot-btn:hover { background-color: #d32f2f; transform: translateY(-2px); }
        #completion-screen {
            display: none;
        }
        #completion-screen h2 {
            color: #2e7d32;
            font-size: 2rem;
        }

        /* --- New Styles --- */
        #progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 2rem;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }
        #nav-controls {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }
        #nav-controls .btn {
            background-color: #607d8b;
            font-size: 0.9rem;
            padding: 10px 20px;
            width: auto;
        }
        #nav-controls .btn:hover {
            background-color: #546e7a;
        }
        #nav-controls .btn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
            transform: none;
        }
        #mode-selection-container {
            margin-bottom: 2rem;
            text-align: left;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1.5rem;
        }
        #mode-selection-container label {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        #mode-selection-container label:hover {
            background-color: #f0f2f5;
        }
        #mode-selection-container input[type="radio"] {
            margin-right: 10px;
            accent-color: #00695c;
            transform: scale(1.1);
        }
        /* 导入词库相关样式 */
        #import-section {
            margin-top: 2rem;
            padding-top: 2rem;
        }

        .import-divider {
            width: 100%;
            height: 1px;
            background: linear-gradient(to right, transparent, #e0e0e0, transparent);
            margin-bottom: 1.5rem;
        }

        #import-section h3 {
            color: #37474f;
            margin-bottom: 1rem;
        }

        .import-btn {
            background-color: #1976d2;
            width: 80%;
            margin: 0.6rem auto;
        }

        .import-btn:hover {
            background-color: #1565c0;
        }

        #import-info {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #757575;
        }

        #import-info details {
            margin-top: 0.5rem;
            text-align: left;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        #import-info summary {
            cursor: pointer;
            color: #1976d2;
            font-weight: 500;
        }

        #import-info summary:hover {
            text-decoration: underline;
        }

        .format-example {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .format-example pre {
            background-color: #fff;
            padding: 0.75rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5rem 0;
            border: 1px solid #e0e0e0;
        }

        /* 导入成功/失败提示 */
        .import-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .import-success {
            background-color: #43a047;
        }

        .import-error {
            background-color: #e53935;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div class="container">
    <div id="start-screen">
        <h1>选择词库</h1>

        <div id="mode-selection-container">
            <label>
                <input type="radio" name="mode" value="zh-ar" checked> 显示中文背阿语
            </label>
            <label>
                <input type="radio" name="mode" value="ar-zh"> 显示阿语背中文
            </label>
            <label>
                <input type="radio" name="mode" value="mixed"> 混合模式
            </label>
        </div>

        <div id="deck-selection-container">
        </div>

        <div id="import-section">
            <div class="import-divider"></div>
            <h3>导入新词库</h3>
            <input type="file" id="file-input" accept=".json,.csv,.js,.txt" style="display: none;">
            <button id="import-btn" class="btn import-btn">
              📁 选择文件导入
            </button>
            <div id="import-info">
                <p>支持格式：JSON、CSV、JS对象</p>
                <details>
                    <summary>查看格式要求</summary>
                    <div class="format-example">
                        <strong>格式1 - 多词库批量导入（推荐）：</strong>
                        <pre>{
    "第二课：你好": [
        {
        "chinese": "谁 (疑问代词)",
        "arabic": "مَنْ",
        "explanation": "مَنْ هُوَ؟ (他是谁？)"
        }
    ],
    "第三课：你叫什么名字": [...]
    }</pre>
                        <strong>格式2 - 单词库JSON：</strong>
                        <pre>{
    "deckName": "基础词汇",
    "words": [
        {
        "chinese": "你好",
        "arabic": "مرحبا",
        "explanation": "常用问候语"
        }
    ]
    }</pre>
                        <strong>格式3 - CSV表格：</strong>
                        <pre>中文,阿拉伯语,解释
    你好,مرحبا,常用问候语
    谢谢,شكرا,表示感谢</pre>
                    </div>
                </details>
            </div>
        </div>
    </div>

        <div id="card-container">
            <div id="progress-container">
                <div id="progress-bar">0%</div>
            </div>
            <h2 id="word-display"></h2>
            <div id="answer-display" class="spoiler" title="点击显示/隐藏答案"></div>
   <p id="explanation-display" class="spoiler"></p>


            <div id="controls">
                <button id="remembered-btn" class="btn">记住了</button>
                <button id="forgot-btn" class="btn">没记住</button>
            </div>
            <div id="nav-controls">
                <button id="prev-btn" class="btn">上一个词</button>
                <button id="back-to-menu-btn" class="btn">返回菜单</button>
            </div>
        </div>

        <div id="completion-screen">
            <h2>🎉 恭喜你完成了本词库的记忆 🎉</h2>
            <p>所有单词都已牢牢记住！</p>
            <button id="finish-back-to-menu-btn" class="btn" style="background-color: #00695c;">返回菜单</button>
        </div>
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
            <h3 style="color: #37474f; margin-bottom: 1rem;">数据管理</h3>
            
            <!-- 第一行按钮 -->
            <button id="view-stats-btn" class="btn" style="background-color: #673ab7; width: 80%; margin: 0.6rem auto;">
                📊 查看学习统计
            </button>
            
            <!-- 第二行按钮 -->
            <button id="export-backup-btn" class="btn" style="background-color: #00897b; width: 80%; margin: 0.6rem auto;">
                💾 导出备份文件
            </button>
            
            <!-- 第三行按钮 -->
            <button id="import-backup-btn" class="btn" style="background-color: #1976d2; width: 80%; margin: 0.6rem auto;">
                📂 导入备份文件
            </button>
            
            <!-- 第四行按钮 -->
            <button id="check-storage-btn" class="btn" style="background-color: #ff6f00; width: 80%; margin: 0.6rem auto;">
                💿 查看存储空间
            </button>
            
            <!-- 第五行按钮（危险操作） -->
            <button id="clear-data-btn" class="btn" style="background-color: #f44336; width: 80%; margin: 0.6rem auto;">
                🗑️ 清除所有数据
            </button>
        </div>
    </div>

    <script>
        // --- NEW: Vocabulary Decks ---
        const vocabularyDecks = {

        };
        // ============= 本地存储功能 =============
        const STORAGE_KEYS = {
            DECKS: 'arabic_vocabulary_decks',
            PROGRESS: 'arabic_learning_progress',
            SETTINGS: 'arabic_app_settings',
            STATS: 'arabic_learning_stats'
        };

        // 初始化统计数据
        let learningStats = {
            totalWordsLearned: 0,
            totalSessions: 0,
            lastStudyDate: null,
            streakDays: 0,
            dailyGoal: 20,
            todayWords: 0
        };

        // 加载本地存储的词库
        function loadDecksFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEYS.DECKS);
                if (stored) {
                    const decks = JSON.parse(stored);
                    Object.assign(vocabularyDecks, decks);
                    console.log(`已加载 ${Object.keys(decks).length} 个词库`);
                }
            } catch (e) {
                console.error('加载词库失败:', e);
            }
        }

        // 保存词库到本地存储
        function saveDecksToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.DECKS, JSON.stringify(vocabularyDecks));
                showImportMessage('词库已自动保存到本地', true);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showImportMessage('存储空间不足，请清理部分词库', false);
                } else {
                    console.error('保存失败:', e);
                }
            }
        }

        // 保存学习进度
        function saveProgress() {
            const progress = {
                currentDeck: currentDeckName,
                wordStates: activeWords.map(w => ({
                    chinese: w.chinese,
                    arabic: w.arabic,
                    explanation: w.explanation,
                    rememberedCount: w.rememberedCount,
                    cooldown: w.cooldown,
                    mistakeCount: w.mistakeCount || 0
                })),
                lastUpdate: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(progress));
        }

        // 加载学习进度
        function loadProgress(deckName) {
            try {
                const stored = localStorage.getItem(STORAGE_KEYS.PROGRESS);
                if (stored) {
                    const progress = JSON.parse(stored);
                    if (progress.currentDeck === deckName) {
                        // 恢复进度
                        const confirmRestore = confirm('检测到上次的学习进度，是否继续？');
                        if (confirmRestore) {
                            return progress.wordStates;
                        }
                    }
                }
            } catch (e) {
                console.error('加载进度失败:', e);
            }
            return null;
        }

        // 更新统计数据
        function updateStats(remembered) {
            const today = new Date().toDateString();
            const lastDate = learningStats.lastStudyDate;
            
            if (lastDate !== today) {
                learningStats.todayWords = 0;
                learningStats.lastStudyDate = today;
                
                // 计算连续天数
                if (lastDate) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (lastDate === yesterday.toDateString()) {
                        learningStats.streakDays++;
                    } else {
                        learningStats.streakDays = 1;
                    }
                } else {
                    learningStats.streakDays = 1;
                }
            }
            
            if (remembered) {
                learningStats.totalWordsLearned++;
                learningStats.todayWords++;
            }
            
            localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(learningStats));
        }

        // 清除所有数据
        function clearAllData() {
            if (confirm('确定要清除所有本地数据吗？（包括词库和学习进度）')) {
                localStorage.clear();
                location.reload();
            }
        }

        // 导出所有数据到文件
        function exportAllDataToFile() {
            const allData = {
                decks: JSON.parse(localStorage.getItem(STORAGE_KEYS.DECKS) || '{}'),
                progress: JSON.parse(localStorage.getItem(STORAGE_KEYS.PROGRESS) || '{}'),
                stats: JSON.parse(localStorage.getItem(STORAGE_KEYS.STATS) || '{}'),
                settings: JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}'),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `阿语学习备份_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showImportMessage('✅ 数据已导出到下载文件夹！', true);
        }

        // 导入备份文件
        function importBackupFile() {
            // 创建一个隐藏的文件输入
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        // 验证备份文件格式
                        if (!backup.exportDate) {
                            throw new Error('不是有效的备份文件');
                        }
                        
                        const confirmMsg = `此备份创建于 ${new Date(backup.exportDate).toLocaleString()}\n确定要恢复此备份吗？（将覆盖当前所有数据）`;
                        
                        if (!confirm(confirmMsg)) return;
                        
                        // 恢复数据
                        if (backup.decks) {
                            localStorage.setItem(STORAGE_KEYS.DECKS, JSON.stringify(backup.decks));
                        }
                        if (backup.progress) {
                            localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(backup.progress));
                        }
                        if (backup.stats) {
                            localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(backup.stats));
                        }
                        if (backup.settings) {
                            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(backup.settings));
                        }
                        
                        showImportMessage('✅ 备份恢复成功！即将刷新页面...', true);
                        setTimeout(() => location.reload(), 1500);
                        
                    } catch (err) {
                        showImportMessage('❌ 备份文件格式错误：' + err.message, false);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 查看存储空间使用情况
        function checkStorageUsage() {
            let totalSize = 0;
            let details = {};
            
            for (let key in localStorage) {
         const value = localStorage.getItem(key); 

         const size = key.length + (value ? value.length : 0);
                totalSize += size;
                
                // 识别是哪种数据
                if (key.includes('decks')) {
                    details['词库数据'] = (size / 1024).toFixed(2) + ' KB';
                } else if (key.includes('progress')) {
                    details['学习进度'] = (size / 1024).toFixed(2) + ' KB';
                } else if (key.includes('stats')) {
                    details['统计数据'] = (size / 1024).toFixed(2) + ' KB';
                }
            }
            
            const totalKB = (totalSize / 1024).toFixed(2);
            const usagePercent = ((totalSize / (5 * 1024 * 1024)) * 100).toFixed(1);
            
            let message = `📊 存储空间使用情况：\n\n`;
            message += `总使用量：${totalKB} KB (${usagePercent}%)\n`;
            message += `剩余空间：约 ${(5120 - parseFloat(totalKB)).toFixed(2)} KB\n\n`;
            message += `详细分类：\n`;
            
            for (let [type, size] of Object.entries(details)) {
                message += `  • ${type}：${size}\n`;
            }
            
            message += `\n预计还可导入约 ${Math.floor((5120 - parseFloat(totalKB)) / 50)} 个词库`;
            
            alert(message);
        }

        // 添加一个当前词库名称变量
        let currentDeckName = '';
        // 获取DOM元素
        const startScreen = document.getElementById('start-screen');
        const cardContainer = document.getElementById('card-container');
        const completionScreen = document.getElementById('completion-screen');
        const deckSelectionContainer = document.getElementById('deck-selection-container');
        
        const wordDisplay = document.getElementById('word-display');
        const answerDisplay = document.getElementById('answer-display');
        const explanationDisplay = document.getElementById('explanation-display');
        
        const rememberedBtn = document.getElementById('remembered-btn');
        const forgotBtn = document.getElementById('forgot-btn');
        const prevBtn = document.getElementById('prev-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const finishBackToMenuBtn = document.getElementById('finish-back-to-menu-btn');

        const progressBar = document.getElementById('progress-bar');

        let activeWords = [];
        let currentWord = null;
        let historyStack = [];
        let currentMode = 'zh-ar'; // 用于存储当前选择的模式
        // 导入功能相关变量
        const fileInput = document.getElementById('file-input');
        const importBtn = document.getElementById('import-btn');

        // 显示导入消息
        function showImportMessage(message, isSuccess = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `import-message ${isSuccess ? 'import-success' : 'import-error'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // 解析CSV文件
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSV文件格式错误：至少需要标题行和一行数据');
            }
            
            const words = [];
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',').map(part => part.trim());
                if (parts.length >= 2) {
                    words.push({
                        chinese: parts[0],
                        arabic: parts[1],
                        explanation: parts[2] || '暂无解释'
                    });
                }
            }
            return words;
        }
        //解析json文件
        function parseJSON(jsonText) {
            try {
                // 清理文本
                let cleanedText = jsonText.trim();
                
                // 1. 尝试直接解析为标准JSON
                try {
                    const data = JSON.parse(cleanedText);
                    return processData(data);
                } catch (e) {
                    // 继续尝试其他格式
                }
                
                // 2. 处理可能的JavaScript对象格式
                // 移除常见的变量声明
                cleanedText = cleanedText
                    .replace(/^(const|let|var)\s+\w+\s*=\s*/, '')  // 移除变量声明
                    .replace(/;[\s\n]*$/, '')  // 移除末尾分号
                    .replace(/\/\*[\s\S]*?\*\//g, '')  // 移除多行注释
                    .replace(/\/\/.*$/gm, '');  // 移除单行注释
                
                // 3. 检查是否缺少外层花括号
                cleanedText = cleanedText.trim();
                if (!cleanedText.startsWith('{')) {
                    // 检查是否是直接的属性列表（如 "xxx": [...], "yyy": [...]）
                    if (cleanedText.match(/^"[^"]+"\s*:/)) {
                        cleanedText = '{' + cleanedText;
                    }
                }
                if (!cleanedText.endsWith('}')) {
                    // 移除末尾可能的逗号
                    cleanedText = cleanedText.replace(/,\s*$/, '');
                    cleanedText = cleanedText + '}';
                }
                
                // 4. 尝试作为JavaScript对象解析
                try {
                    // 使用更安全的方式解析JavaScript对象
                    const data = new Function('return ' + cleanedText)();
                    return processData(data);
                } catch (e) {
                    // 继续尝试
                }
                
                // 5. 最后尝试：修复常见的JSON错误
                cleanedText = cleanedText
                    .replace(/,\s*}/g, '}')  // 移除对象末尾的逗号
                    .replace(/,\s*]/g, ']')  // 移除数组末尾的逗号
                    .replace(/'/g, '"')  // 将单引号替换为双引号
                    .replace(/(\w+):/g, '"$1":');  // 给没有引号的属性名加引号
                
                const data = JSON.parse(cleanedText);
                return processData(data);
                
            } catch (error) {
                throw new Error(`解析失败，请检查文件格式。原始错误：${error.message}`);
            }
        }

        // 处理解析后的数据
        function processData(data) {
            // 检查是否是单词库格式（有deckName和words字段）
            if (data.deckName && data.words && Array.isArray(data.words)) {
                // 格式2：单词库格式
                data.words.forEach((word, index) => {
                    if (!word.chinese || !word.arabic) {
                        throw new Error(`第${index + 1}个单词缺少必要字段（chinese 或 arabic）`);
                    }
                    if (!word.explanation) {
                        word.explanation = '暂无解释';
                    }
                });
                return { type: 'single', data: data };
            } else {
                // 格式1：多词库格式（对象的每个属性都是一个词库）
                const decks = {};
                let totalWords = 0;
                
                for (const [deckName, words] of Object.entries(data)) {
                    if (Array.isArray(words)) {
                        // 验证每个单词
                        words.forEach((word, index) => {
                            if (!word.chinese || !word.arabic) {
                                throw new Error(`词库"${deckName}"的第${index + 1}个单词缺少必要字段`);
                            }
                            if (!word.explanation) {
                                word.explanation = '暂无解释';
                            }
                        });
                        decks[deckName] = words;
                        totalWords += words.length;
                    }
                }
                
                if (Object.keys(decks).length === 0) {
                    throw new Error('未找到有效的词库数据');
                }
        
        return { type: 'multiple', data: decks, totalWords: totalWords };
    }
}

        // 处理文件导入
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedCount = 0;
                    let importedDecks = [];
                    
                    if (file.name.endsWith('.csv')) {
                        // CSV格式处理
                        const words = parseCSV(content);
                        let deckName = file.name.replace('.csv', '').replace(/[_-]/g, ' ');
                        
                        // 如果词库名称已存在，添加数字后缀
                        let finalDeckName = deckName;
                        let counter = 1;
                        while (vocabularyDecks[finalDeckName]) {
                            finalDeckName = `${deckName} (${counter})`;
                            counter++;
                        }
                        
                        vocabularyDecks[finalDeckName] = words;
                        importedCount = words.length;
                        importedDecks.push(finalDeckName);
                        
                    } else {
                        // JSON/JS格式处理
                        const result = parseJSON(content);
                        
                        if (result.type === 'single') {
                            // 单词库导入
                            const data = result.data;
                            let deckName = data.deckName;
                            
                            // 检查是否存在
                            if (vocabularyDecks[deckName]) {
                                const overwrite = confirm(`词库"${deckName}"已存在，是否覆盖？`);
                                if (!overwrite) {
                                    // 添加数字后缀
                                    let counter = 1;
                                    while (vocabularyDecks[`${deckName} (${counter})`]) {
                                        counter++;
                                    }
                                    deckName = `${deckName} (${counter})`;
                                }
                            }
                            
                            vocabularyDecks[deckName] = data.words;
                            importedCount = data.words.length;
                            importedDecks.push(deckName);
                            
                        } else if (result.type === 'multiple') {
                            // 多词库批量导入
                            const decks = result.data;
                            let skippedDecks = [];
                            
                            for (const [deckName, words] of Object.entries(decks)) {
                                if (vocabularyDecks[deckName]) {
                                    const overwrite = confirm(`词库"${deckName}"已存在（${words.length}个词），是否覆盖？`);
                                    if (!overwrite) {
                                        skippedDecks.push(deckName);
                                        continue;
                                    }
                                }
                                vocabularyDecks[deckName] = words;
                                importedDecks.push(deckName);
                                importedCount += words.length;
                            }
                            
                            // 如果有跳过的词库，显示提示
                            if (skippedDecks.length > 0) {
                                setTimeout(() => {
                                    showImportMessage(`已跳过 ${skippedDecks.length} 个已存在的词库`, false);
                                }, 500);
                            }
                        }
                    }
                    
                    // 刷新词库选择界面
                    setupSelectionScreen();
                    //保存到本地
                    saveDecksToStorage(); 
                    
                    // 显示成功消息
                    if (importedDecks.length === 1) {
                        showImportMessage(`成功导入词库"${importedDecks[0]}"（${importedCount}个单词）`);
                    } else {
                        showImportMessage(`成功导入 ${importedDecks.length} 个词库（共${importedCount}个单词）`);
                    }
                    
                    // 清空文件输入
                    fileInput.value = '';
                    
                } catch (error) {
                    showImportMessage(`导入失败：${error.message}`, false);
                    fileInput.value = '';
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // 导入按钮点击事件
        importBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // 文件选择事件
        fileInput.addEventListener('change', handleFileImport);

        // 查看统计
        const viewStatsBtn = document.getElementById('view-stats-btn');
        if (viewStatsBtn) {
            viewStatsBtn.addEventListener('click', () => {
                const stats = JSON.parse(localStorage.getItem(STORAGE_KEYS.STATS) || '{}');
                const totalDecks = Object.keys(vocabularyDecks).length;
                const totalWords = Object.values(vocabularyDecks).reduce((sum, deck) => sum + deck.length, 0);
                
                alert(`📊 学习统计：
                
        📚 词库数量：${totalDecks}
        📝 总词汇量：${totalWords}
        ✅ 已掌握：${stats.totalWordsLearned || 0}
        📅 连续学习：${stats.streakDays || 0} 天
        🎯 今日学习：${stats.todayWords || 0} 词
        🏆 总学习次数：${stats.totalSessions || 0}`);
            });
        }

        // 导出备份
        const exportBackupBtn = document.getElementById('export-backup-btn');
        if (exportBackupBtn) {
            exportBackupBtn.addEventListener('click', exportAllDataToFile);
        }

        // 导入备份
        const importBackupBtn = document.getElementById('import-backup-btn');
        if (importBackupBtn) {
            importBackupBtn.addEventListener('click', importBackupFile);
        }

        // 查看存储空间
        const checkStorageBtn = document.getElementById('check-storage-btn');
        if (checkStorageBtn) {
            checkStorageBtn.addEventListener('click', checkStorageUsage);
        }

        // 清除数据
        const clearDataBtn = document.getElementById('clear-data-btn');
        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', clearAllData);
        }


        function setupSelectionScreen() {
            deckSelectionContainer.innerHTML = '';
            Object.keys(vocabularyDecks).forEach(deckName => {
                const button = document.createElement('button');
                button.textContent = `${deckName} (${vocabularyDecks[deckName].length}词)`;  // 显示词数
                button.className = 'btn deck-btn';
                if (vocabularyDecks[deckName].length === 0) {
                    button.disabled = true;
                    button.title = '此词库暂无内容';
                }
                // 传递 deckName 参数
                button.addEventListener('click', () => startSession(vocabularyDecks[deckName], deckName));
                deckSelectionContainer.appendChild(button);
            });
        }

        function showScreen(screen) {
            startScreen.style.display = 'none';
            cardContainer.style.display = 'none';
            completionScreen.style.display = 'none';
            screen.style.display = 'block';
        }
        
        function updateProgressBar() {
            if (activeWords.length === 0) return;
            const learnedCount = activeWords.filter(w => w.rememberedCount >= 3).length;
            const progress = Math.round((learnedCount / activeWords.length) * 100);
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
        }

                function displayCard(word) {
            explanationDisplay.textContent = `💡 解释: ${word.explanation}`;

            let showChinese = true; // 默认显示中文

            // 根据全局变量 currentMode 决定显示内容
            if (currentMode === 'mixed') {
                showChinese = Math.random() < 0.5; // 混合模式：随机
            } else if (currentMode === 'ar-zh') {
                showChinese = false; // 阿背中：不显示中文
            }
            // (如果 currentMode === 'zh-ar', showChinese 保持为 true)

            if (showChinese) {
                // 模式 "zh-ar" 或 混合模式的中文面
                wordDisplay.textContent = word.chinese;
                wordDisplay.style.direction = 'ltr';
                answerDisplay.innerHTML = word.arabic.replace(/\n/g, '<br>');
                answerDisplay.style.direction = 'rtl';
            } else {
                // 模式 "ar-zh" 或 混合模式的阿语面
                wordDisplay.innerHTML = word.arabic.replace(/\n/g, '<br>');
                wordDisplay.style.direction = 'rtl';
                answerDisplay.textContent = word.chinese;
                answerDisplay.style.direction = 'ltr';
            }

            // 重置答案为隐藏状态
            answerDisplay.classList.remove('revealed');
            answerDisplay.classList.add('spoiler');
            
            // 重置解释为隐藏状态 (确保这一步也包含在内)
            explanationDisplay.classList.remove('revealed');
            explanationDisplay.classList.add('spoiler');
        }

function startSession(vocabulary, deckName) {  // 添加 deckName 参数
    currentDeckName = deckName;  // 保存当前词库名
    
    const selectedMode = document.querySelector('input[name="mode"]:checked');
    if (selectedMode) {
        currentMode = selectedMode.value;
    } else {
        currentMode = 'zh-ar';
    }
    
    // 尝试加载之前的进度
    const savedProgress = loadProgress(deckName);
    if (savedProgress) {
        activeWords = vocabulary.map(word => {
            const saved = savedProgress.find(s => 
                s.chinese === word.chinese && s.arabic === word.arabic
            );
            return saved || {
                ...word,
                rememberedCount: 0,
                cooldown: 0,
                mistakeCount: 0
            };
        });
    } else {
        initialize(vocabulary);
    }
    
    showScreen(cardContainer);
    showNextWord();
    
    // 更新统计
    learningStats.totalSessions++;
    updateStats(false);
}
    // 重置答案为隐藏状态
    answerDisplay.classList.remove('revealed');
    answerDisplay.classList.add('spoiler');
    // 新增：重置解释为隐藏状态    explanationDisplay.classList.remove('revealed');
    explanationDisplay.classList.add('spoiler');
        function initialize(vocabulary) {
            activeWords = vocabulary.map(word => ({
                ...word,
                rememberedCount: 0,
                cooldown: 0,
            }));
            historyStack = [];
            currentWord = null;
            updateProgressBar();
        }

        function showNextWord() {
            // Push the current word to history before getting the next one
            if (currentWord) {
                historyStack.push(currentWord);
            }
            prevBtn.disabled = historyStack.length === 0;

            activeWords.forEach(w => {
                if (w.cooldown > 0) w.cooldown--;
            });

            let wordsToLearn = activeWords.filter(w => w.rememberedCount < 3);

            if (wordsToLearn.length === 0) {
                showScreen(completionScreen);
                return;
            }

            let availablePool = wordsToLearn.filter(w => w.cooldown === 0);
            
            if (availablePool.length === 0) {
                wordsToLearn.sort((a, b) => a.cooldown - b.cooldown);
                currentWord = wordsToLearn[0];
            } else {
                const randomIndex = Math.floor(Math.random() * availablePool.length);
                currentWord = availablePool[randomIndex];
            }
            
            displayCard(currentWord);
            updateProgressBar();
        }
        
        // --- Event Listeners ---
                
        answerDisplay.addEventListener('click', () => {
            // 切换答案的显示
            answerDisplay.classList.toggle('spoiler');
            answerDisplay.classList.toggle('revealed');

            // 同时切换解释的显示
            explanationDisplay.classList.toggle('spoiler');
            explanationDisplay.classList.toggle('revealed');
        });

        rememberedBtn.addEventListener('click', () => {
            if (!currentWord) return;
            currentWord.rememberedCount++;
            currentWord.cooldown = 11;
            updateStats(true);  // 更新统计
            saveProgress();     // 保存进度
            showNextWord();
        });

        forgotBtn.addEventListener('click', () => {
            if (!currentWord) return;
            currentWord.cooldown = Math.floor(Math.random() * 4) + 2;
            currentWord.mistakeCount = (currentWord.mistakeCount || 0) + 1;  // 记录错误次数
            updateStats(false);  // 更新统计
            saveProgress();      // 保存进度
            showNextWord();
        });

        prevBtn.addEventListener('click', () => {
            if (historyStack.length > 0) {
                currentWord = historyStack.pop();
                displayCard(currentWord);
                prevBtn.disabled = historyStack.length === 0;
            }
        });

        const goBackToMenu = () => {
            showScreen(startScreen);
        };

        backToMenuBtn.addEventListener('click', goBackToMenu);
        finishBackToMenuBtn.addEventListener('click', goBackToMenu);

        // --- Initial Load ---
        window.onload = () => {
            loadDecksFromStorage();

            const savedStats = localStorage.getItem(STORAGE_KEYS.STATS);
            if (savedStats) {
                learningStats = JSON.parse(savedStats);
            }
            
            setupSelectionScreen();
            showScreen(startScreen);
        };

    </script>

</body>
</html>
